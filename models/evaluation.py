"""Evaluation models in the evaluation schema.

These models are managed by Alembic migrations and store evaluation data.
"""

import uuid

from sqlalchemy import (
    BigInteger,
    Column,
    ForeignKey,
    Text,
    UniqueConstraint,
)
from sqlalchemy.dialects.postgresql import JSONB, UUID
from sqlalchemy.orm import Mapped, relationship

from models.base import Base, ModifyModel


class EmployeeEvaluation(ModifyModel, Base):
    """Stores employee evaluation records with transcription feedback.

    Each employee can have one evaluation record (upsert pattern).
    The feedback column stores the latest transcription text.
    """

    __tablename__ = "employee_evaluation"
    __table_args__ = (
        UniqueConstraint("employee_id", name="uq_employee_evaluation_employee_id"),
        {"schema": "evaluation"},
    )

    id: Mapped[uuid.UUID] = Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
    )

    employee_id: Mapped[int] = Column(
        BigInteger,
        ForeignKey("public.employee.id"),
        nullable=False,
    )

    feedback: Mapped[str] = Column(
        Text,
        nullable=False,
    )

    # Relationship to reports
    evaluation_reports: Mapped[list["EmployeeEvaluationReports"]] = relationship(
        "EmployeeEvaluationReports",
        back_populates="evaluation",
        lazy="select",
    )


class EmployeeEvaluationReports(ModifyModel, Base):
    """Stores individual evaluation reports generated by Claude.

    Each report is linked to an EmployeeEvaluation record.
    The report column stores the validated JSON evaluation data.
    """

    __tablename__ = "employee_evaluation_reports"
    __table_args__ = {"schema": "evaluation"}

    id: Mapped[uuid.UUID] = Column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
    )

    employee_evaluation_id: Mapped[uuid.UUID] = Column(
        UUID(as_uuid=True),
        ForeignKey("evaluation.employee_evaluation.id"),
        nullable=False,
    )

    report: Mapped[dict] = Column(
        JSONB,
        nullable=False,
        default=dict,
    )

    # Relationship to parent evaluation
    evaluation: Mapped[EmployeeEvaluation] = relationship(
        "EmployeeEvaluation",
        back_populates="evaluation_reports",
        lazy="select",
    )
